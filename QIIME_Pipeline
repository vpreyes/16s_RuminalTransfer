#!/usr/bin/env bash
set -euo pipefail

# ===== USER EDITS =====
ENV="qiime2-amplicon-2026.1"

# Directory with RAW (untrimmed) paired-end FASTQs
RAW_DIR="/ReyesHD/16s_Colombia_TransferProj/raw_reads"

# Manifest for RAW reads (paired-end). Must have 3 columns:
# sample-id  forward-absolute-filepath  reverse-absolute-filepath
RAW_MANIFEST="${RAW_DIR}/Manifest.raw.auto.tsv"

# Output working directory
OUT_DIR="/ReyesHD/16s_Colombia_TransferProj/qiime2_retrim_v3v4"
THREADS=12

# Primers (V3–V4)
FWD_PRIMER="CCTAYGGGRBGCASCAG"
REV_PRIMER="GGACTACNNGGGTATCTAAT"
# ======================

source ~/miniforge3/etc/profile.d/conda.sh
conda activate "${ENV}"

mkdir -p "${OUT_DIR}"
cd "${OUT_DIR}"

echo "### 1) Import raw reads"
qiime tools import \
  --type 'SampleData[PairedEndSequencesWithQuality]' \
  --input-path "${RAW_MANIFEST}" \
  --output-path demux-raw.qza \
  --input-format PairedEndFastqManifestPhred33V2

echo "### 2) Trim primers with cutadapt (keeps reads long; removes primers wherever found)"
# Notes:
# - --p-front-f/--p-front-r remove primers from the 5' end.
# - --p-adapter-f/--p-adapter-r remove the reverse-complement primer if it appears at the 3' end.
# - --p-discard-untrimmed keeps only reads where primers are found (usually desired for amplicons).
qiime cutadapt trim-paired \
  --i-demultiplexed-sequences demux-raw.qza \
  --p-cores "${THREADS}" \
  --p-front-f "${FWD_PRIMER}" \
  --p-front-r "${REV_PRIMER}" \
  --p-adapter-f "${REV_PRIMER}" \
  --p-adapter-r "${FWD_PRIMER}" \
  --p-discard-untrimmed \
  --o-trimmed-sequences demux-trimmed.qza \
  --o-modified-sequences demux-modified.qza

echo "### 3) Summarize trimmed reads (check lengths/quality)"
qiime demux summarize \
  --i-data demux-trimmed.qza \
  --o-visualization demux-trimmed.qzv

echo "### 4) DADA2 denoise paired"
# Start conservative: keep reads long to ensure overlap for ~460 bp V3–V4
# Then tune trunc lengths based on demux-trimmed.qzv quality + denoising_stats.qzv
qiime dada2 denoise-paired \
  --i-demultiplexed-seqs demux-trimmed.qza \
  --p-n-threads "${THREADS}" \
  --p-trunc-len-f 0 \
  --p-trunc-len-r 0 \
  --p-max-ee-f 2 \
  --p-max-ee-r 5 \
  --p-n-reads-learn 500000 \
  --p-chimera-method consensus \
  --output-dir dada2_out/v245_245_ee2_5

echo "### 5) Denoising stats"
qiime metadata tabulate \
  --m-input-file dada2_out/v245_245_ee2_5/denoising_stats.qza \
  --o-visualization dada2_out/v245_245_ee2_5/denoising_stats.qzv

echo "DONE. Open demux-trimmed.qzv and denoising_stats.qzv to tune trunc lengths."

#Export stats
qiime metadata tabulate \
  --m-input-file stats-dada2.qza \
  --o-visualization stats-dada2.qzv

# Export Feature Table and Representative Sequences
qiime tools export \
  --input-path table-dada2.qza \
  --output-path asv_table
biom convert -i feature-table.biom -o feature-table-abundance.tsv --to-tsv

# =========================
# 1) DADA2 stats (view)
# =========================
qiime metadata tabulate \
  --m-input-file stats-dada2.qza \
  --o-visualization stats-dada2.qzv


# =========================
# 2) Taxonomy assignment (VSEARCH vs SILVA)
# =========================
qiime feature-classifier classify-consensus-vsearch \
  --i-query representative_sequences.qza \
  --i-reference-reads /ReyesHD/16s_Amplicon_Seqdata/CleanData/Togo/silva-138-99-seqs.qza \
  --i-reference-taxonomy /ReyesHD/16s_Amplicon_Seqdata/CleanData/Togo/silva-138-99-tax.qza \
  --p-maxaccepts 7 \
  --p-query-cov 0.8 \
  --p-perc-identity 0.9 \
  --p-threads 16 \
  --o-classification taxonomy.qza \
  --o-search-results search_results.qza


# =========================
# 3) Remove contaminants (chloroplast/mitochondria)
#    (Optional: also remove Archaea/Eukaryota/Unassigned)
# =========================
qiime taxa filter-table \
  --i-table table-dada2.qza \
  --i-taxonomy taxonomy.qza \
  --p-exclude mitochondria,chloroplast \
  --o-filtered-table table-dada2.noCP.noMT.qza

qiime taxa filter-seqs \
  --i-sequences rep-seqs-dada2.qza \
  --i-taxonomy taxonomy.qza \
  --p-exclude mitochondria,chloroplast \
  --o-filtered-sequences rep-seqs-dada2.noCP.noMT.qza

# If you ALSO want to remove non-bacterial / unknown assignments, use this instead:
# --p-exclude mitochondria,chloroplast,Archaea,Eukaryota,Unassigned


# =========================
# 4) Export filtered Feature Table + Rep-seqs
# =========================
mkdir -p asv_table_filtered asvs_filtered

qiime tools export \
  --input-path table-dada2.noCP.noMT.qza \
  --output-path asv_table_filtered

biom convert \
  -i asv_table_filtered/feature-table.biom \
  -o asv_table_filtered/feature-table-abundance.tsv \
  --to-tsv

qiime tools export \
  --input-path rep-seqs-dada2.noCP.noMT.qza \
  --output-path asvs_filtered


# =========================
# 5) Visualize filtered rep-seqs (optional QC)
# =========================
qiime feature-table tabulate-seqs \
  --i-data rep-seqs-dada2.noCP.noMT.qza \
  --o-visualization rep-seqs-dada2.noCP.noMT.qzv
